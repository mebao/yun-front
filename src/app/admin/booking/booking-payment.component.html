<header-nav></header-nav>
<div class="content-section admin-booking-payment">
	<top-bar [data]="topBar"></top-bar>
	<div class="pure-g">
		<div class="pure-u-1-5 booking-tab pr10">
			<div class="info">
				姓名：{{bookingInfo.childName}}
			</div>
			<div class="info">
				年龄：{{bookingInfo.age}}
			</div>
			<div class="info">
				家长：{{bookingInfo.creatorName}}
			</div>
		</div>
		<div class="pure-u-4-5 pure-form">
			<div class="second-bar-tab flex">
				<div class="item active">费用详情</div>
			</div>
			<div *ngIf="pageType == '1'" class="mt10">
				暂无费用信息
			</div>
			<div *ngIf="pageType == ''">
				<div class="flex" *ngIf="bookingInfo.status == '5'">
					<div class="flex-1"></div>
					<div class="flex-0"><button (click)="print()" target="_blank" class="print-btn pure-button mt10">打印</button></div>
				</div>
				<div *ngIf="bookingInfo.status != '5' && userMember.member" class="text-right mt20">
					<button *ngIf="editMemberType == 'update'" (click)="cancelMember()" class="pure-button">取消</button>
					<button *ngIf="editMemberType != 'update'" (click)="updateMember()" class="pure-button pure-button-primary">修改折扣</button>
					<button *ngIf="editMemberType == 'update'" (click)="saveMember()" class="pure-button pure-button-primary">保存</button>
				</div>
				<div class="section">
					<div class="title">医生科室费用</div>
					<div class="pad10">
						<table class="pure-table pure-table-horizontal table-tab w100">
							<thead>
								<tr>
									<th>科室</th>
									<th>总价</th>
									<th class="width-lg">备注</th>
									<ng-container *ngIf="dataCode == '1'">
										<th>折扣</th>
										<th>折后金额</th>
									</ng-container>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let service of fee.feeInfo.serviceFeeList; let index=index;">
									<td>{{service.serviceName}}</td>
									<td>{{service.fee}}</td>
									<td>
										<div class="text-lg">{{service.remark}}</div>
									</td>
									<ng-container *ngIf="dataCode == '1'">
										<td>
											<span *ngIf="editMemberType != 'update'">{{service.serviceDiscount}}%</span>
											<div *ngIf="editMemberType == 'update'" class="flex">
												<input type="number" name="service_{{index}}" [(ngModel)]="service.serviceDiscount" (change)="changeDiscount(service.serviceDiscount, service.serviceName)" class="flex-1 w100">
												<div class="pt5">%</div>
											</div>
										</td>
										<td>{{service.serviceFee}}</td>
									</ng-container>
								</tr>
								<ng-container *ngIf="dataCode == '1'">
									<tr>
										<td colspan="5">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.serviceOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<tr>
										<td colspan="5">
											<div class="flex">
												<div class="flex-1 text-right">折扣金额：</div>
												<div class="w100p">{{fee.feeInfo.serviceDiscount}}</div>
											</div>
										</td>
									</tr>
									<tr>
										<td colspan="5">
											<div class="flex">
												<div class="flex-1 text-right">已付预约费用：</div>
												<div class="w100p">{{fee.feeInfo.bookingFee}}</div>
											</div>
										</td>
									</tr>
									<tr>
										<td colspan="5">
											<div class="flex">
												<div class="flex-1 text-right">应收费用：</div>
												<div class="w100p">{{fee.feeInfo.serviceFee}}</div>
											</div>
										</td>
									</tr>
								</ng-container>
								<ng-container *ngIf="dataCode == '0'">
									<tr>
										<td colspan="3">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.serviceOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<tr>
										<td colspan="3">
											<div class="flex">
												<div class="flex-1 text-right">折扣金额：</div>
												<div class="w100p">{{fee.feeInfo.serviceDiscount}}</div>
											</div>
										</td>
									</tr>
									<tr>
										<td colspan="3">
											<div class="flex">
												<div class="flex-1 text-right">已付预约费用：</div>
												<div class="w100p">{{fee.feeInfo.bookingFee}}</div>
											</div>
										</td>
									</tr>
									<tr>
										<td colspan="3">
											<div class="flex">
												<div class="flex-1 text-right">应收费用：</div>
												<div class="w100p">{{fee.feeInfo.serviceFee}}</div>
											</div>
										</td>
									</tr>
								</ng-container>
							</tbody>
						</table>
					</div>
				</div>
				<div *ngIf="fee.feeInfo.assistFeeList.length > 0" class="section">
					<div class="title">辅助治疗费用</div>
					<div class="pad10">
						<table class="pure-table pure-table-horizontal table-tab w100">
							<thead>
								<tr>
									<th>辅助治疗</th>
									<th>单价</th>
									<th>数量</th>
									<th>总价</th>
									<th class="width-lg">备注</th>
									<ng-container *ngIf="dataCode == '1'">
										<th>折扣</th>
										<th>折后金额</th>
									</ng-container>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let assist of fee.feeInfo.assistFeeList; let index=index;">
									<td>{{assist.projectName}}</td>
									<td>{{assist.price}}</td>
									<td>{{assist.number}}</td>
									<td>{{assist.fee}}</td>
									<td>
										<div class="text-lg">{{assist.remark}}</div>
									</td>
									<ng-container *ngIf="dataCode == '1'">
										<td>
											<span *ngIf="editMemberType != 'update'">{{assist.assistDiscount}}%</span>
											<div *ngIf="editMemberType == 'update'" class="flex">
												<input type="number" name="assist_{{index}}" [(ngModel)]="assist.assistDiscount" (change)="changeDiscount(assist.assistDiscount, assist.projectName)" class="flex-1 w100">
												<div class="pt5">%</div>
											</div>
										</td>
										<td>{{assist.assistFee}}</td>
									</ng-container>
								</tr>
								<ng-container *ngIf="dataCode == '1'">
									<tr>
										<td colspan="7">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.assistOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<ng-container *ngIf="fee.feeInfo.assistOriginalFee != fee.feeInfo.assistDiscount">
										<tr>
											<td colspan="7">
												<div class="flex">
													<div class="flex-1 text-right">折扣金额：</div>
													<div class="w100p">{{fee.feeInfo.assistDiscount}}</div>
												</div>
											</td>
										</tr>
										<tr>
											<td colspan="7">
												<div class="flex">
													<div class="flex-1 text-right">应收费用：</div>
													<div class="w100p">{{fee.feeInfo.assistFee}}</div>
												</div>
											</td>
										</tr>
									</ng-container>
								</ng-container>
								<ng-container *ngIf="dataCode == '0'">
									<tr>
										<td colspan="5">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.assistOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<ng-container *ngIf="fee.feeInfo.assistOriginalFee != fee.feeInfo.assistDiscount">
										<tr>
											<td colspan="5">
												<div class="flex">
													<div class="flex-1 text-right">折扣金额：</div>
													<div class="w100p">{{fee.feeInfo.assistDiscount}}</div>
												</div>
											</td>
										</tr>
										<tr>
											<td colspan="5">
												<div class="flex">
													<div class="flex-1 text-right">应收费用：</div>
													<div class="w100p">{{fee.feeInfo.assistFee}}</div>
												</div>
											</td>
										</tr>
									</ng-container>
								</ng-container>
							</tbody>
						</table>
					</div>
				</div>
				<div *ngIf="fee.feeInfo.checkFeeList.length" class="section">
					<div class="title">检查项目费用</div>
					<div class="pad10">
						<table class="pure-table pure-table-horizontal table-tab w100">
							<thead>
								<tr>
									<th>检查</th>
									<th>总价</th>
									<th class="width-lg">备注</th>
									<ng-container *ngIf="dataCode == '1'">
										<th>折扣</th>
										<th>折后金额</th>
									</ng-container>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let check of fee.feeInfo.checkFeeList; let index=index;">
									<td>{{check.projectName}}</td>
									<td>{{check.fee}}</td>
									<td>
										<div class="text-lg">{{check.remark}}</div>
									</td>
									<ng-container *ngIf="dataCode == '1'">
										<td>
											<span *ngIf="editMemberType != 'update'">{{check.checkDiscount}}%</span>
											<div *ngIf="editMemberType == 'update'" class="flex">
												<input type="number" name="check_{{index}}" [(ngModel)]="check.checkDiscount" (change)="changeDiscount(check.checkDiscount, check.projectName)" class="flex-1 w100">
												<div class="pt5">%</div>
											</div>
										</td>
										<td>{{check.checkFee}}</td>
									</ng-container>
								</tr>
								<ng-container *ngIf="dataCode == '1'">
									<tr>
										<td colspan="5">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.checkOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<ng-container *ngIf="fee.feeInfo.checkOriginalFee != fee.feeInfo.checkDiscount">
										<tr>
											<td colspan="5">
												<div class="flex">
													<div class="flex-1 text-right">折扣金额：</div>
													<div class="w100p">{{fee.feeInfo.checkDiscount}}</div>
												</div>
											</td>
										</tr>
										<tr>
											<td colspan="5">
												<div class="flex">
													<div class="flex-1 text-right">应收费用：</div>
													<div class="w100p">{{fee.feeInfo.checkFee}}</div>
												</div>
											</td>
										</tr>
									</ng-container>
								</ng-container>
								<ng-container *ngIf="dataCode == '0'">
									<tr>
										<td colspan="3">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.checkOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<ng-container *ngIf="fee.feeInfo.checkOriginalFee != fee.feeInfo.checkDiscount">
										<tr>
											<td colspan="3">
												<div class="flex">
													<div class="flex-1 text-right">折扣金额：</div>
													<div class="w100p">{{fee.feeInfo.checkDiscount}}</div>
												</div>
											</td>
										</tr>
										<tr>
											<td colspan="3">
												<div class="flex">
													<div class="flex-1 text-right">应收费用：</div>
													<div class="w100p">{{fee.feeInfo.checkFee}}</div>
												</div>
											</td>
										</tr>
									</ng-container>
								</ng-container>
							</tbody>
						</table>
					</div>
				</div>
				<div *ngIf="fee.feeInfo.medicalFeeList.length > 0" class="section">
					<div class="title">药方药品费用</div>
					<div class="pad10">
						<table class="pure-table pure-table-horizontal table-tab w100">
							<thead>
								<tr>
									<th>药品</th>
									<th>单价</th>
									<th>总量</th>
									<th>总价</th>
									<th>是否优惠</th>
									<th class="width-lg">备注</th>
									<ng-container *ngIf="dataCode == '1'">
										<th>折扣</th>
										<th>折后金额</th>
									</ng-container>
								</tr>
							</thead>
							<tbody>
								<ng-container *ngFor="let medical of fee.feeInfo.medicalFeeList; let index=index;">
									<tr *ngFor="let info of medical.info">
										<td>{{info.pname}}</td>
										<td>{{info.price}}</td>
										<td>{{info.num}}</td>
										<td>{{info.fee}}</td>
										<td>{{info.canDiscount == '0' ? '不可优惠' : '可以优惠'}}</td>
										<td>
											<div class="text-lg">{{info.remark}}</div>
										</td>
										<ng-container *ngIf="dataCode == '1'">
											<td>
												<span *ngIf="editMemberType != 'update'">{{info.msDiscount}}%</span>
												<div *ngIf="editMemberType == 'update'" class="flex">
													<input type="number" name="info_{{index}}" [(ngModel)]="info.msDiscount" (change)="changeDiscount(info.msDiscount, info.pname)" class="flex-1 w100">
													<div class="pt5">%</div>
												</div>
											</td>
											<td>{{info.msFee}}</td>
										</ng-container>
									</tr>
								</ng-container>
								<ng-container *ngIf="dataCode == '1'">
									<tr>
										<td colspan="8">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.medicalOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<ng-container *ngIf="fee.feeInfo.medicalOriginalFee != fee.feeInfo.medicalDiscount">
										<tr>
											<td colspan="8">
												<div class="flex">
													<div class="flex-1 text-right">折扣金额：</div>
													<div class="w100p">{{fee.feeInfo.medicalDiscount}}</div>
												</div>
											</td>
										</tr>
										<tr>
											<td colspan="8">
												<div class="flex">
													<div class="flex-1 text-right">应收费用：</div>
													<div class="w100p">{{fee.feeInfo.medicalFee}}</div>
												</div>
											</td>
										</tr>
									</ng-container>
								</ng-container>
								<ng-container *ngIf="dataCode == '0'">
									<tr>
										<td colspan="6">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.medicalOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<ng-container *ngIf="fee.feeInfo.medicalOriginalFee != fee.feeInfo.medicalDiscount">
										<tr>
											<td colspan="6">
												<div class="flex">
													<div class="flex-1 text-right">折扣金额：</div>
													<div class="w100p">{{fee.feeInfo.medicalDiscount}}</div>
												</div>
											</td>
										</tr>
										<tr>
											<td colspan="6">
												<div class="flex">
													<div class="flex-1 text-right">应收费用：</div>
													<div class="w100p">{{fee.feeInfo.medicalFee}}</div>
												</div>
											</td>
										</tr>
									</ng-container>
								</ng-container>
							</tbody>
						</table>
					</div>
				</div>
				<div *ngIf="fee.feeInfo.otherFeeList.length > 0" class="section">
					<div class="title">其他费用</div>
					<div class="pad10">
						<table class="pure-table pure-table-horizontal table-tab w100">
							<thead>
								<tr>
									<th>消费项目</th>
									<th>单价</th>
									<th>数量</th>
									<th>总价</th>
									<th class="width-lg">备注</th>
									<ng-container *ngIf="dataCode == '1'">
										<th>折扣</th>
										<th>折后金额</th>
									</ng-container>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let other of fee.feeInfo.otherFeeList; let index=index;">
									<td>{{other.projectName}}</td>
									<td>{{other.price}}</td>
									<td>{{other.number}}</td>
									<td>{{other.fee}}</td>
									<td>
										<div class="text-lg">{{other.remark}}</div>
									</td>
									<ng-container *ngIf="dataCode == '1'">
										<td>
											<span *ngIf="editMemberType != 'update'">{{other.otherDiscount}}%</span>
											<div *ngIf="editMemberType == 'update'" class="flex">
												<input type="number" name="other_{{index}}" [(ngModel)]="other.otherDiscount" (change)="changeDiscount(other.otherDiscount, other.projectName)" class="flex-1 w100">
												<div class="pt5">%</div>
											</div>
										</td>
										<td>{{other.otherFee}}</td>
									</ng-container>
								</tr>
								<ng-container *ngIf="dataCode == '1'">
									<tr>
										<td colspan="7">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.otherOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<ng-container *ngIf="fee.feeInfo.otherOriginalFee != fee.feeInfo.otherDiscount">
										<tr>
											<td colspan="7">
												<div class="flex">
													<div class="flex-1 text-right">折扣金额：</div>
													<div class="w100p">{{fee.feeInfo.otherDiscount}}</div>
												</div>
											</td>
										</tr>
										<tr>
											<td colspan="7">
												<div class="flex">
													<div class="flex-1 text-right">应收费用：</div>
													<div class="w100p">{{fee.feeInfo.otherFee}}</div>
												</div>
											</td>
										</tr>
									</ng-container>
								</ng-container>
								<ng-container *ngIf="dataCode == '0'">
									<tr>
										<td colspan="5">
											<div class="flex">
												<div class="flex-1 text-right">费用合计：</div>
												<div class="w100p">{{fee.feeInfo.otherOriginalFee}}</div>
											</div>
										</td>
									</tr>
									<ng-container *ngIf="fee.feeInfo.otherOriginalFee != fee.feeInfo.otherDiscount">
										<tr>
											<td colspan="5">
												<div class="flex">
													<div class="flex-1 text-right">折扣金额：</div>
													<div class="w100p">{{fee.feeInfo.otherDiscount}}</div>
												</div>
											</td>
										</tr>
										<tr>
											<td colspan="5">
												<div class="flex">
													<div class="flex-1 text-right">应收费用：</div>
													<div class="w100p">{{fee.feeInfo.otherFee}}</div>
												</div>
											</td>
										</tr>
									</ng-container>
								</ng-container>
							</tbody>
						</table>
					</div>
				</div>
				<div class="section">
					<div class="title flex">
						<div class="flex-1 text-right">费用合计：</div>
						<div class="w100p">{{fee.originalCost}}</div>
					</div>
				</div>
				<div class="section">
					<div class="title flex">
						<div class="flex-1 text-right">应收费用：</div>
						<div class="w100p">{{fee.fee}}</div>
					</div>
				</div>
				<!-- <div class="section">
					<div class="title flex">
						<div class="flex-1 text-right">实收费用：</div>
						<div class="w100p">{{fee.realFee}}</div>
					</div>
				</div> -->
				<div *ngIf="bookingInfo.status == '5'" class="section">
					<div class="title">
						备注：{{fee.remark}}
					</div>
				</div>
				<div class="mt10 text-right">
					<button *ngIf="bookingInfo.status == '5'" class="pure-button">订单已完成</button>
					<button *ngIf="bookingInfo.status != '5' && fee.canPay == '1'" (click)="pay()" class="pure-button pure-button-primary">支付</button>
					<button *ngIf="bookingInfo.status != '5' && fee.canPay == '0'" class="pure-button">操作未完成，不能完成支付(退药操作未完成)</button>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="modal" *ngIf="modalTab">
	<div class="modal-mask" (click)="close()"></div>
	<div class="container">
		<div class="title">支付</div>
		<div class="content pad10 pure-form form-tab">
			<div class="pure-control-group flex">
				<label for="user" class="w150p mr20 text-right">用户：</label>
				<label class="flex-1">{{bookingInfo.creatorName}}</label>
			</div>
			<div class="pure-control-group flex">
				<label for="member" class="w150p mr20 text-right">余额：</label>
				<label>{{userMember.balance}}</label>
				<div *ngIf="moduleAuthority.recharge" class="flex-1 ml20">
					<button (click)="recharge()" class="pure-button pure-button-primary">充值</button>
				</div>
			</div>
			<div class="pure-control-group flex">
				<label for="fee" class="w150p mr20 text-right">消费金额：</label>
				<label class="flex-1">{{fee.fee}}</label>
			</div>
			<div class="pure-control-group flex mt10">
				<label for="give_amount" class="w150p mr20 text-right">减免金额：</label>
				<input type="number" id="give_amount" name="give_amount" step="0.01" [(ngModel)]="payInfo.give_amount" (keyup)="changeMoney('give_amount')" placeholder="请输入减免金额" class="flex-1">
			</div>
			<div class="pure-control-group flex mt10">
				<label for="remark" class="w150p mr20 text-right">减免金额原因：</label>
				<textarea id="remark" name="remark" rows="2" maxlength="200" [(ngModel)]="payInfo.remark" placeholder="请输入减免金额原因" class="flex-1 auto"></textarea>
			</div>
			<div class="pure-control-group flex mt10">
				<label for="pay_way" class="w150p mr20 text-right">
					<span>支付方式</span>
					<span class="required">*</span>：
				</label>
				<div class="flex-1">
					<div class="flex flex-wrap pay-list">
						<div *ngFor="let payway of paywayList" class="item" (click)="changePayway(payway, (payway.key == 'member' ? payInfo.memberBalance : true) && payway.use)"  [ngClass]="{'disabled': payway.key == 'member' && !payInfo.memberBalance || !payway.use, 'active': payInfo.payway.way == payway.key || payInfo.payway_second.way == payway.key}">
							{{payway.value}}{{payway.key == 'member' ? (payInfo.memberBalance ? '' : '（余额不足）') : ''}}
						</div>
					</div>
				</div>
			</div>
			<div *ngIf="payInfo.payway.way != ''" class="pure-control-group flex">
				<label for="user" class="w150p mr20 text-right">{{payInfo.payway.text}}：</label>
				<div class="flex-1">
					<input type="number" step="0.01" [(ngModel)]="payInfo.payway.money" (keyup)="changeMoney('payway')" placeholder="请输入{{payInfo.payway.text}}金额">
				</div>
			</div>
			<div *ngIf="payInfo.payway_second.way != ''" class="pure-control-group flex">
				<label for="user" class="w150p mr20 text-right">{{payInfo.payway_second.text}}：</label>
				<div class="flex-1">
					<input type="number" step="0.01" [(ngModel)]="payInfo.payway_second.money" (keyup)="changeMoney('payway_second')" placeholder="请输入{{payInfo.payway_second.text}}金额">
				</div>
			</div>
			<div class="pure-control-group flex">
				<label for="user" class="w150p mr20 text-right">还需支付：</label>
				<label class="flex-1">{{payInfo.stillNeedPay}}</label>
			</div>
		</div>
		<div class="button-tab pad10 text-right">
			<button (click)="close()" class="pure-button">取消</button>
			<button (click)="confirmPay()" class="pure-button pure-button-primary" [disabled]="btnCanEdit || payInfo.stillNeedPay != '0.00'">确认支付</button>
		</div>
	</div>
</div>
<modal-toast modalTab="{{toast.show}}" text="{{toast.text}}" type="{{toast.type}}"></modal-toast>
<loading [show]="loadingShow"></loading>
